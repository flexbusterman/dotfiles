#!/bin/bash

DEVICE="${1:?Missing MAC address as argument}"
CONNECTED=$(bluetoothctl devices | cut -f2 -d' ' | while read uuid; do bluetoothctl info $uuid; done|grep -e "Connected" | awk '{print $NF}')
echo $CONNECTED
POWERED=$(bluetoothctl show | grep -i powered | grep -i yes)

if [[ $POWERED ]]; then
    if [[ $CONNECTED == yes ]]; then
        echo "Restarting bluetooth service" 
        SUDO_ASKPASS=~/.local/bin/dmenupass sudo -A systemctl restart bluetooth.service && bluetoothctl power on && bluetoothctl -- connect $1
    else
        echo "Bluetooth powered but not connected" 
        bluetoothctl -- connect $1
    fi
else
    echo "Bluetooth not powered" 
    bluetoothctl power on && bluetoothctl -- connect $1
fi


# SINK=$(pactl info | grep -i "default sink" | sed "s/.*\.//g")

# PROFILE="bluez_card.$(echo "$1" | sed "s/:/_/g")"

# # attempt to set sink 10 times
# for i in {1..10}
# do
    # if [[ "$SINK" == "a2dp_sink" ]]; then
        # notify-send "Device $1 connected with a2dp_sink" 
        # echo "a2dp_sink active. Success! Exiting."
        # exit 1
    # else
        # echo "Setting sink"
        # pactl set-card-profile $PROFILE a2dp_sink
        # sleep 1
        # SINK=$(pactl info | grep -i "default sink" | sed "s/.*\.//g")
        # echo "Sink is now $SINK"
    # fi
# done
