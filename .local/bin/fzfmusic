#!/bin/bash

# Define the array of supported file types
declare -a filetypes=("mp3" "ogg" "flac" "wav" "m4a" "opus" "mp4" "m4p" "m4b" "m4r" "3gp" "aac" "mka" "wma" "ape" "mpc" "tta" "wv" "spx" "aiff" "mod" "s3m" "xm" "it" "mo3" "mtm" "umx" "mid" "midi" "sid" "ac3" "dts")

# Variable to keep track of the first file added
first=""

# Start fzf and store the selection
selection=$(find ~/Music/ | fzf)

# Check if the selection is not empty
if [[ -n "$selection" ]]; then
    # Check if the selection is a file and in the supported file types
    if [[ -f "$selection" && " ${filetypes[@]} " =~ " ${selection##*.} " ]]; then
        mpc --host ~/.mpd/socket add "$selection"
        # notify-send "Added to MPD: $selection"
        if [[ -z "$first" ]]; then
            first="$selection"
        fi
    elif [[ -d "$selection" ]]; then
        # If the selection is a directory, add all supported files in it
        for file in "$selection"/*; do
            if [[ " ${filetypes[@]} " =~ " ${file##*.} " ]]; then
                mpc --host ~/.mpd/socket add "$file"
                if [[ -z "$first" ]]; then
                    first="$file"
                fi
            fi
        done
        # notify-send "Added directory to MPD: $selection"
    else
        notify-send "Unsupported file type"
    fi
fi

# Play the first song added
if [[ -n "$first" ]]; then
    # Extract just the filename from the path
    filename_only="${first##*/}"
    # Remove the file extension
    filename_only="${filename_only%.*}"
    mpc --host ~/.mpd/socket searchplay filename "$filename_only"
fi
