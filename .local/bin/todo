#!/usr/bin/env bash

awk '
/^\* TODO/ {
    # Capture the entire TODO line
    todo_line = $0

    # Extract the text after "* TODO"
    # This removes "* TODO " and any trailing space
    sub(/^\* TODO[ \t]*/, "", todo_line)

    # Check if there is a priority marker [#X] at the start
    priority = "C"  # default priority
    if (match(todo_line, /^\[#([A-Za-z])\]/, arr)) {
        priority = arr[1]
        # Remove the priority marker [#X] and any surrounding spaces
        sub(/^\[#.[ \t]*\]/, "", todo_line)
        sub(/^[ \t]+/, "", todo_line)
    }

    # Save just the name of the todo for later printing
    todo_name = todo_line

    # Read the next line to check if it is a SCHEDULED date
    getline
    if ($1 == "SCHEDULED:" && $2 ~ /<([0-9]{4}-[0-9]{2}-[0-9]{2})/) {
        scheduled_date = substr($2, 2, 10)
        if (scheduled_date <= strftime("%Y-%m-%d")) {
            print todo_name
        }
    } else {
        # If there is no SCHEDULED or it does not match, print the todo name
        print todo_name
    }
}
' ~/ORGMODE/* | head -n 1 | sed 's/ \+\:.*//'
