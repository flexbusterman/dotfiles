#!/usr/bin/env bash
set -Eeuo pipefail

default="$(pactl get-default-sink)"

echo "$default"

links="$(pw-link -lI 2>/dev/null)"

# Use awk to extract IDs:
#   $2 must be the arrow "|<-"
#   $4 must be REAPER:out<number>
# Then sort uniquely (numeric) and load into array.
mapfile -t bitwigOutIDs < <( awk '$2=="|<-" && $4 ~ /^REAPER:out[0-9]+$/ { print $1 }' <<<"$links")

# Disconnect all connected Reaper outputs
for bitwigOutID in "${bitwigOutIDs[@]}"; do
	echo "$bitwigOutID"
	pw-link -d $bitwigOutID
done

echo "default: $default"

connectReaper() {
	if [[ $default =~ "Steinberg" ]]; then
		pw-link REAPER:out1 $default:playback_AUX0
		pw-link REAPER:out2 $default:playback_AUX1
		pw-link "Steinberg UR22:capture_AUX0" REAPER:in1
		pw-link "Steinberg UR22:capture_AUX1" REAPER:in2
	else
		pw-link REAPER:out1 $default:playback_FL
		pw-link REAPER:out2 $default:playback_FR
	fi
}

connectBitwig() {
	if [[ $default =~ "Steinberg" ]]; then
		pw-link "Bitwig Studio:Stereo Out_L" $default:playback_AUX0
		pw-link "Bitwig Studio:Stereo Out_R" $default:playback_AUX1
		pw-link "Steinberg UR22:capture_AUX0" "Bitwig Studio:Stereo In_L"
		pw-link "Steinberg UR22:capture_AUX1" "Bitwig Studio:Stereo In_R"
	else
		pw-link "Bitwig Studio:Stereo Out_L" $default:playback_FL
		pw-link "Bitwig Studio:Stereo Out_R" $default:playback_FR
	fi
}

[[ $(pgrep reaper) ]] && connectReaper
[[ $(pgrep bitwig) ]] && connectBitwig
